#  SquadManager

## Overview
SquadManager is an iOS iPad application that allows users to manage their X-Wing TMG 2.0 squads.  Users can import XWS data generated by a squad builder like yasb or LaunchBayNext.  Once a squad is imported, the user is able to view pilot details including ship statuses, dial and upgrade cards along with their status.  Multiple squads can be marked as favorites or deleted.

## Development Notes
### Architecture
The architecture is a mix of Elm with the addition of view models.  Instead of the view communicating with the Elm store directly, the view sends commands to the view model that forwards commands to the Elm store.  Once the state in the store has been updated, the view model will observe any changes to the state and update the publishers that the view model exposes to the view.

![Redux Architecture](https://pakirby1.github.io/images/Redux_Architecture.png)

In general, the order of operations are:

1. User performs an action
2. The action is sent to the view model for pre-processing.  The user action is translated into a store Action.  This Action is usually represented as an enum with associated values.
3. The reducer mutates the State based on the Action and service calls
4. The store emits an event that contains the updated state
5. The view model performs any post-processing operations on the event and stores the result in a publisher
6. The view updates its state based on the events published by the view model.

> Usually an app will have a single Store with a single State.  Alternatively, an app could have a single Store with multiple states, or multiple Stores each with one or more States.

## Views
There are multiple views within the app, but the main views are:

* Squad View: Displays a single squad
* Squad Import View: Imports XWS from a squad builder
* Squad List View: Displays a list of all imported squads
* Ship View: Displays a single pilot/ship combination

## `FactionSquadList.swift`
A list of operations/actions that can occur on the `Store`

### `FactionSquadListViewModel`

#### `FactionSquadListViewModel.ViewProperties`
```
@Published var squadNames : [String] = []
@Published var numSquads: Int = 0
@Published var squadDataList: [SquadData] = []
```

|Operation|Action|
|------|-----------|
|`loadSquadsList()`|`.loadSquadsList`|
|`deleteSquad(SquadData)`|`.deleteSquad(SquadData)`|
|`updateSquad(SquadData)`|`.updateSquad(SquadData)`|
|`refreshSquadsList()`|`.refreshSquadsList`|
|`updateFavorites(Bool)`|`.updateFavorites(Bool)`|

### `FactionSquadCardViewModel`

#### `FactionSquadCardViewModel.ViewProperties`
```
let points: Int = 150
let theme: Theme = WestworldUITheme()
let squadData: SquadData
let deleteCallback: (SquadData) -> ()
let updateCallback: (SquadData) -> ()
var buttonBackground: Color
var textForeground: Color
var border: Color
var json: String
var squad: Squad
```

## `SquadView.swift`

### `SquadViewModel.ViewProperties`
```
@Published var alertText: String = ""
@Published var showAlert: Bool = false
var squad: Squad
var squadData: SquadData
@Published var displayAsList: Bool = true
```

### `SquadCardView.ViewProperties`
```
let squad: Squad
let squadData: SquadData
let displayAsList: Bool
let theme: Theme = WestworldUITheme()
@State var shipPilots: [ShipPilot] = []
@State var activationOrder: Bool = true
@State private var revealAllDials: Bool = false
var chunkedShips : [[ShipPilot]]
var sortedShipPilots: [ShipPilot]
var damagedPoints: Int
```

### `PilotCardView.ViewProperties`
```
let theme: Theme = WestworldUITheme()
let shipPilot: ShipPilot
let dialRevealed: Bool
```

### `PilotDetailsView.ViewProperties`
```
let displayUpgrades: Bool
let displayHeaders: Bool
let displayDial: Bool
let theme: Theme = WestworldUITheme()
@State var currentManeuver: String = ""
```

### Squad Actions
|Operation|Action|
|------|-----------|
|`loadSquadsList()`|`.loadSquadsList`|
|`deleteSquad(SquadData)`|`.deleteSquad(SquadData)`|
|`updateSquad(SquadData)`|`.updateSquad(SquadData)`|
|`refreshSquadsList()`|`.refreshSquadsList`|
|`updateFavorites(Bool)`|`.updateFavorites(Bool)`|
|`loadSquad(String)`|`.loadSquad(String)`|
|`getShips(Squad, SquadData)`|`.getShips(Squad, SquadData)`|
|`updateAllDials(Bool)`|`.updateAllDials(Bool)`|
|`flipDial()`|`.flipDial`|

### Squad State
```
struct SquadState {
    // collection properties
    var squadDataList: [SquadData]
    var numSquads: Int
    var squadNames : [String]
    
    // selected squad
    let points: Int
    let squadData: SquadData
    var json: String
    var squad: Squad
    @Published var displayAsList: Bool = true
    @State var shipPilots: [ShipPilot] = []
    @State private var revealAllDials: Bool = false
    var chunkedShips : [[ShipPilot]]
    var sortedShipPilots: [ShipPilot]
    var damagedPoints: Int
    
    // selected ship
    let shipPilot: ShipPilot
    let dialRevealed: Bool
    @State var currentManeuver: String = ""
}
```

### UI State
``` 
struct UIState {
    let theme: Theme = WestworldUITheme()
    var buttonBackground: Color
    var textForeground: Color
    var border: Color
}
```

### LinkedView
To get updates from the charge buttons within a `LinkedView`, the view will need to reference the `viewProperties` stream on the view model.  

![Linked View Model Diagram](https://pakirby1.github.io/images/LinkedViewModel.001.png)

#### LinkedView
The view will read the view properties on the view model and use the properties to render the view.

```
struct LinkedView : View {

}
```

#### LinkedViewModel
The view model will observe changes to the store and build view properties based on the observed changes.

``` 
class LinkedViewModel : ObservableObject {

}
```

#### Store
The store exposes the state via an `@Published` property wrapper

```
class Store : ObservableObject {

}
```

#### PilotState
The pilot state or `PilotStateData` object exposes each type of charge (hull, force, shield, charge) as a computed property of type `ChargeType`.  This type stores the active & inactive values as well as an update closure that is excuted by the `increment()` & `decrement()` functions

```
struct ChargeType {
    let active: Int
    let inactive: Int
    let update: (Int, Int) -> PilotStateData
}
```

